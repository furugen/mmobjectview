<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ============================================================ -->
  <!-- CSS: Google Material Design ãƒ™ãƒ¼ã‚¹ / ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ           -->
  <!-- ============================================================ -->
  <style>
    /* ---- ãƒªã‚»ãƒƒãƒˆ & ãƒ™ãƒ¼ã‚¹ ---- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Google Sans', 'Roboto', 'Noto Sans JP', Arial, sans-serif;
      font-size: 13px;
      color: #202124;
      background: #fff;
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* ---- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ---- */
    .section {
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
    }

    .section:last-child {
      border-bottom: none;
    }

    .section-title {
      font-size: 11px;
      font-weight: 500;
      color: #5f6368;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    /* ---- ãƒœã‚¿ãƒ³ ---- */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      outline: none;
      text-decoration: none;
      width: 100%;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #1a73e8;
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      background: #1765cc;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .btn-danger {
      background: #fff;
      color: #d93025;
      border: 1px solid #dadce0;
    }

    .btn-danger:hover:not(:disabled) {
      background: #fce8e6;
    }

    .btn-secondary {
      background: #fff;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #e8f0fe;
    }

    .btn-expand {
      padding: 4px 12px;
      font-size: 12px;
      width: auto;
      min-width: 56px;
      border-radius: 16px;
      background: #e8f0fe;
      color: #1a73e8;
      border: none;
    }

    .btn-expand:hover:not(:disabled) {
      background: #d2e3fc;
    }

    /* ---- æ¥ç¶šçŠ¶æ…‹ãƒãƒƒã‚¸ ---- */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-connected {
      background: #e6f4ea;
      color: #1e8e3e;
    }

    .status-disconnected {
      background: #fce8e6;
      color: #d93025;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.green { background: #1e8e3e; }
    .status-dot.red { background: #d93025; }

    /* ---- ç’°å¢ƒåˆ‡æ›¿ ---- */
    .env-selector {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }

    .env-btn {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      background: #fff;
      font-family: inherit;
      font-size: 12px;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.2s;
    }

    .env-btn.active {
      background: #e8f0fe;
      color: #1a73e8;
      border-color: #1a73e8;
      font-weight: 500;
    }

    .env-btn:hover:not(.active) {
      background: #f1f3f4;
    }

    /* ---- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ ---- */
    .search-box {
      position: relative;
      margin-bottom: 8px;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px 8px 32px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-family: inherit;
      font-size: 13px;
      color: #202124;
      outline: none;
      transition: border-color 0.2s;
    }

    .search-input:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #9aa0a6;
      font-size: 14px;
    }

    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border: 1px solid #dadce0;
      border-radius: 16px;
      font-size: 11px;
      color: #5f6368;
      cursor: pointer;
      transition: all 0.15s;
      background: #fff;
      user-select: none;
    }

    .filter-chip.active {
      background: #e8f0fe;
      color: #1a73e8;
      border-color: #1a73e8;
    }

    .filter-chip:hover {
      background: #f1f3f4;
    }

    .filter-chip.active:hover {
      background: #d2e3fc;
    }

    .filter-chip input[type="checkbox"] {
      display: none;
    }

    /* ---- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ ---- */
    .object-list-container {
      max-height: 360px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }

    .object-count {
      font-size: 11px;
      color: #9aa0a6;
      margin-bottom: 4px;
    }

    .object-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid #f1f3f4;
      transition: background 0.1s;
    }

    .object-item:last-child {
      border-bottom: none;
    }

    .object-item:hover {
      background: #f8f9fa;
    }

    .object-info {
      flex: 1;
      min-width: 0;
      margin-right: 8px;
    }

    .object-label {
      font-size: 13px;
      font-weight: 500;
      color: #202124;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .object-name {
      font-size: 11px;
      color: #9aa0a6;
      font-family: 'Roboto Mono', monospace;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .object-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 500;
      margin-left: 4px;
    }

    .badge-custom {
      background: #fef7e0;
      color: #b06000;
    }

    .badge-standard {
      background: #e8eaed;
      color: #5f6368;
    }

    /* ---- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ ---- */
    .progress-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.92);
      z-index: 100;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .progress-overlay.visible {
      display: flex;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid #e0e0e0;
      border-top-color: #1a73e8;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .progress-message {
      font-size: 13px;
      color: #5f6368;
      text-align: center;
    }

    /* ---- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚¨ãƒ©ãƒ¼ / æˆåŠŸï¼‰ ---- */
    .message-banner {
      display: none;
      padding: 10px 14px;
      border-radius: 4px;
      font-size: 12px;
      margin: 8px 0;
      line-height: 1.4;
    }

    .message-banner.visible {
      display: block;
    }

    .message-error {
      background: #fce8e6;
      color: #c5221f;
      border-left: 3px solid #d93025;
    }

    .message-success {
      background: #e6f4ea;
      color: #137333;
      border-left: 3px solid #1e8e3e;
    }

    .message-info {
      background: #e8f0fe;
      color: #1967d2;
      border-left: 3px solid #1a73e8;
    }

    .message-banner a {
      color: inherit;
      font-weight: 500;
    }

    .message-close {
      float: right;
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      color: inherit;
      opacity: 0.6;
      line-height: 1;
      padding: 0 0 0 8px;
    }

    .message-close:hover {
      opacity: 1;
    }

    /* ---- ãƒ•ãƒƒã‚¿ãƒ¼ ---- */
    .footer {
      padding: 8px 16px;
      text-align: center;
      font-size: 10px;
      color: #bdc1c6;
      border-top: 1px solid #e0e0e0;
    }

    /* ---- éè¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼ ---- */
    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>

  <!-- ============================================================ -->
  <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³                                                -->
  <!-- ============================================================ -->
  <div class="section" id="authSection">
    <div class="section-title">Salesforce æ¥ç¶š <small style="color:#999;font-size:12px;">build:7</small></div>

    <!-- æœªèªè¨¼æ™‚ -->
    <div id="authDisconnected">
      <div class="status-badge status-disconnected">
        <span class="status-dot red"></span>
        æœªæ¥ç¶š
      </div>
      <div class="env-selector">
        <button class="env-btn active" id="envProduction" onclick="selectEnvironment('production')">æœ¬ç•ª</button>
        <button class="env-btn" id="envSandbox" onclick="selectEnvironment('sandbox')">Sandbox</button>
      </div>
      <div style="margin-top: 10px;">
        <button class="btn btn-primary" id="btnConnect" onclick="connectSalesforce()">
          Salesforce ã«æ¥ç¶š
        </button>
      </div>
    </div>

    <!-- èªè¨¼æ¸ˆã¿ -->
    <div id="authConnected" class="hidden">
      <div class="status-badge status-connected">
        <span class="status-dot green"></span>
        æ¥ç¶šä¸­
      </div>
      <div style="margin-top: 4px; font-size: 11px; color: #5f6368;" id="instanceUrlDisplay"></div>
      <div style="margin-top: 8px;">
        <button class="btn btn-danger" onclick="disconnectSalesforce()">åˆ‡æ–­</button>
      </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="authMessage" class="message-banner"></div>
  </div>

  <!-- ============================================================ -->
  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ»æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆèªè¨¼å¾Œã«è¡¨ç¤ºï¼‰                        -->
  <!-- ============================================================ -->
  <div class="section hidden" id="filterSection">
    <div class="section-title">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ¤œç´¢</div>

    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input type="text" class="search-input" id="searchInput"
             placeholder="ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåã¾ãŸã¯ãƒ©ãƒ™ãƒ«ã§æ¤œç´¢..."
             oninput="debounceFilter()">
    </div>

    <div class="filter-options">
      <label class="filter-chip active" id="chipQueryable" onclick="toggleFilter(this, 'queryableOnly')">
        <input type="checkbox" checked> ã‚¯ã‚¨ãƒªå¯èƒ½
      </label>
      <label class="filter-chip" id="chipCustomOnly" onclick="toggleFilter(this, 'customOnly')">
        <input type="checkbox"> ã‚«ã‚¹ã‚¿ãƒ ã®ã¿
      </label>
    </div>
  </div>

  <!-- ============================================================ -->
  <!-- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆèªè¨¼å¾Œã«è¡¨ç¤ºï¼‰                      -->
  <!-- ============================================================ -->
  <div class="section hidden" id="objectListSection">
    <div class="section-title">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</div>
    <div class="object-count" id="objectCount"></div>
    <div class="object-list-container" id="objectListContainer">
      <!-- JS ã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>
  </div>

  <!-- ============================================================ -->
  <!-- çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³                                       -->
  <!-- ============================================================ -->
  <div class="section hidden" id="resultSection">
    <div id="resultMessage" class="message-banner"></div>
  </div>

  <!-- ============================================================ -->
  <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤                                         -->
  <!-- ============================================================ -->
  <div class="progress-overlay" id="progressOverlay">
    <div class="spinner"></div>
    <div class="progress-message" id="progressMessage">å‡¦ç†ä¸­...</div>
  </div>

  <!-- ============================================================ -->
  <!-- ãƒ•ãƒƒã‚¿ãƒ¼                                                      -->
  <!-- ============================================================ -->
  <div class="footer">
    Salesforce Object Explorer v1.0.0
  </div>

  <!-- ============================================================ -->
  <!-- JavaScript                                                    -->
  <!-- ============================================================ -->
  <script>
    // ============================================================
    // çŠ¶æ…‹ç®¡ç†
    // ============================================================

    /** å…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸã‚ªãƒªã‚¸ãƒŠãƒ«ï¼‰ */
    var allObjects = [];

    /** ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š */
    var currentFilters = {
      keyword: '',
      customOnly: false,
      queryableOnly: true
    };

    /** ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã‚¿ã‚¤ãƒãƒ¼ */
    var filterTimer = null;

    /** å‡¦ç†ä¸­ãƒ•ãƒ©ã‚° */
    var isProcessing = false;

    // ============================================================
    // åˆæœŸåŒ–
    // ============================================================

    /**
     * ã‚µã‚¤ãƒ‰ãƒãƒ¼èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«èªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
     */
    // === ãƒ‡ãƒãƒƒã‚°ç”¨: å…ƒã®initã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ ===
    // å…ƒã®ã‚³ãƒ¼ãƒ‰ã¯å¾Œã§æˆ»ã™ã®ã§å‰Šé™¤ã—ãªã„ã§ãã ã•ã„
    /*
    (function init() {
      console.log('[init] checkAuthStatus å‘¼ã³å‡ºã—é–‹å§‹');
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('[init] checkAuthStatus æˆåŠŸ:', JSON.stringify(result));
          onAuthStatusReceived(result);
        })
        .withFailureHandler(function(error) {
          console.error('[init] checkAuthStatus å¤±æ•—:', error.message, error);
          onRuntimeError(error);
        })
        .checkAuthStatus();
    })();
    */

    // === ãƒ‡ãƒãƒƒã‚°ç”¨: æœ€å°ãƒ†ã‚¹ãƒˆ ===
    (function init() {
      console.log('[init] testPing å‘¼ã³å‡ºã—é–‹å§‹');
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('[init] testPing æˆåŠŸ:', JSON.stringify(result));
          showMessageHtml('authMessage',
            'âœ… ã‚µãƒ¼ãƒãƒ¼é€šä¿¡æˆåŠŸï¼<br><small>' + escapeHtml(JSON.stringify(result)) + '</small>',
            'success');
        })
        .withFailureHandler(function(error) {
          console.error('[init] testPing å¤±æ•—:', error.message, error);
          showMessageHtml('authMessage',
            'âŒ testPingã‚‚å¤±æ•—<br><small>' + escapeHtml(error.message) + '</small><br><small>' + escapeHtml(JSON.stringify(error)) + '</small>',
            'error');
        })
        .testPing();
    })();

    // ============================================================
    // èªè¨¼é–¢é€£
    // ============================================================

    /**
     * èªè¨¼çŠ¶æ…‹ã®ç¢ºèªçµæœã‚’å—ã‘å–ã‚‹
     */
    function onAuthStatusReceived(result) {
      if (!result.success) {
        showMessage('authMessage', result.error.message, 'error');
        return;
      }

      var data = result.data;

      // ç’°å¢ƒãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’è¨­å®š
      setEnvironmentButtons(data.environment);

      if (data.authenticated) {
        showConnectedState(data.instanceUrl);
        loadObjectList();
      } else {
        showDisconnectedState();
      }
    }

    /**
     * Salesforce ã«æ¥ç¶šã™ã‚‹ï¼ˆèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ï¼‰
     */
    function connectSalesforce() {
      if (isProcessing) return;
      setButtonLoading('btnConnect', true, 'æ¥ç¶šä¸­...');

      google.script.run
        .withSuccessHandler(function(result) {
          setButtonLoading('btnConnect', false, 'Salesforce ã«æ¥ç¶š');
          if (result.success) {
            // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§èªè¨¼URLã‚’é–‹ã
            var authWindow = window.open(result.data.authUrl, '_blank',
              'width=600,height=700,menubar=no,toolbar=no,status=no');
            // èªè¨¼å®Œäº†ã‚’å¾…ã¤ãƒãƒ¼ãƒªãƒ³ã‚°
            pollAuthCompletion(authWindow);
          } else {
            showMessage('authMessage', result.error.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          setButtonLoading('btnConnect', false, 'Salesforce ã«æ¥ç¶š');
          showMessage('authMessage', 'æ¥ç¶šã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        })
        .getAuthorizationUrl();
    }

    /**
     * èªè¨¼å®Œäº†ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã§ç›£è¦–ã™ã‚‹
     * èªè¨¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æ›´æ–°
     * æœ€å¤§5åˆ†é–“ï¼ˆ300ç§’ï¼‰ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
     */
    function pollAuthCompletion(authWindow) {
      var pollCount = 0;
      var maxPolls = 300; // 1ç§’Ã—300å› = 5åˆ†
      var pollInterval = setInterval(function() {
        pollCount++;
        try {
          if (!authWindow || authWindow.closed) {
            clearInterval(pollInterval);
            // èªè¨¼çŠ¶æ…‹ã‚’å†ãƒã‚§ãƒƒã‚¯
            google.script.run
              .withSuccessHandler(onAuthStatusReceived)
              .withFailureHandler(onRuntimeError)
              .checkAuthStatus();
          } else if (pollCount >= maxPolls) {
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 5åˆ†ä»¥ä¸ŠçµŒé
            clearInterval(pollInterval);
            try { authWindow.close(); } catch (closeErr) { /* ignore */ }
            showMessage('authMessage', 'èªè¨¼ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
          }
        } catch (e) {
          // cross-origin ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒSalesforceã®ãƒšãƒ¼ã‚¸ã«ã„ã‚‹é–“ï¼‰
        }
      }, 1000);
    }

    /**
     * Salesforce ã¨ã®æ¥ç¶šã‚’åˆ‡æ–­ã™ã‚‹
     */
    function disconnectSalesforce() {
      if (isProcessing) return;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showDisconnectedState();
            hideMessage('authMessage');
            allObjects = [];
            showMessage('authMessage', 'æ¥ç¶šã‚’è§£é™¤ã—ã¾ã—ãŸã€‚', 'info');
          } else {
            showMessage('authMessage', result.error.message, 'error');
          }
        })
        .withFailureHandler(onRuntimeError)
        .logout();
    }

    /**
     * ç’°å¢ƒã‚’é¸æŠã™ã‚‹ï¼ˆæœ¬ç•ª / Sandboxï¼‰
     */
    function selectEnvironment(env) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            setEnvironmentButtons(env);
            showDisconnectedState();
            showMessage('authMessage', result.message, 'info');
          } else {
            showMessage('authMessage', result.error.message, 'error');
          }
        })
        .withFailureHandler(onRuntimeError)
        .switchEnvironment(env);
    }

    // ============================================================
    // UI çŠ¶æ…‹ç®¡ç†
    // ============================================================

    /** æ¥ç¶šæ¸ˆã¿çŠ¶æ…‹ã®è¡¨ç¤º */
    function showConnectedState(instanceUrl) {
      document.getElementById('authDisconnected').classList.add('hidden');
      document.getElementById('authConnected').classList.remove('hidden');
      document.getElementById('filterSection').classList.remove('hidden');
      document.getElementById('objectListSection').classList.remove('hidden');

      if (instanceUrl) {
        document.getElementById('instanceUrlDisplay').textContent = instanceUrl;
      }
    }

    /** æœªæ¥ç¶šçŠ¶æ…‹ã®è¡¨ç¤º */
    function showDisconnectedState() {
      document.getElementById('authDisconnected').classList.remove('hidden');
      document.getElementById('authConnected').classList.add('hidden');
      document.getElementById('filterSection').classList.add('hidden');
      document.getElementById('objectListSection').classList.add('hidden');
      document.getElementById('resultSection').classList.add('hidden');

      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
      document.getElementById('objectListContainer').innerHTML = '';
      document.getElementById('objectCount').textContent = '';
    }

    /** ç’°å¢ƒãƒœã‚¿ãƒ³ã® active çŠ¶æ…‹ã‚’è¨­å®š */
    function setEnvironmentButtons(env) {
      document.getElementById('envProduction').classList.toggle('active', env === 'production');
      document.getElementById('envSandbox').classList.toggle('active', env === 'sandbox');
    }

    /** ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ */
    function setButtonLoading(btnId, loading, text) {
      var btn = document.getElementById(btnId);
      if (!btn) return;
      btn.disabled = loading;
      btn.textContent = text || btn.textContent;
    }

    // ============================================================
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
    // ============================================================

    /**
     * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã™ã‚‹
     */
    function loadObjectList() {
      if (isProcessing) return;
      showProgress('ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—ä¸­...');

      // Code.gs ã® fetchObjects() ã‚’å‘¼ã³å‡ºã™
      // â€» SalesforceApi.gs ã® getObjectList() ã¨ã®é–¢æ•°åè¡çªã‚’é¿ã‘ã‚‹ãŸã‚ã€
      //    Code.gs ã§ã¯ fetchObjects ã¨ã„ã†åå‰ã®ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰é–¢æ•°ã‚’å®šç¾©
      google.script.run
        .withSuccessHandler(function(result) {
          hideProgress();
          if (result.success) {
            allObjects = result.data.objects || [];
            applyFilters();
          } else {
            showMessage('authMessage', result.error.message, 'error');
            // èªè¨¼åˆ‡ã‚Œã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã™
            if (result.error.code === 'AUTH_REQUIRED' || result.error.code === 'AUTH_EXPIRED') {
              showDisconnectedState();
            }
          }
        })
        .withFailureHandler(function(error) {
          hideProgress();
          showMessage('authMessage', 'ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        })
        .fetchObjects(null);
    }

    /**
     * ãƒ•ã‚£ãƒ«ã‚¿ã‚’ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã—ã¦é©ç”¨ã™ã‚‹ï¼ˆæ¤œç´¢å…¥åŠ›æ™‚ï¼‰
     */
    function debounceFilter() {
      clearTimeout(filterTimer);
      filterTimer = setTimeout(function() {
        currentFilters.keyword = document.getElementById('searchInput').value.trim();
        applyFilters();
      }, 250);
    }

    /**
     * ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒƒãƒ—ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹
     */
    function toggleFilter(chip, filterKey) {
      currentFilters[filterKey] = !currentFilters[filterKey];
      chip.classList.toggle('active', currentFilters[filterKey]);
      applyFilters();
    }

    /**
     * ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
     */
    function applyFilters() {
      var keyword = currentFilters.keyword.toLowerCase();
      var filtered = allObjects.filter(function(obj) {
        // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
        if (keyword) {
          var nameMatch = (obj.name || '').toLowerCase().indexOf(keyword) >= 0;
          var labelMatch = (obj.label || '').toLowerCase().indexOf(keyword) >= 0;
          if (!nameMatch && !labelMatch) return false;
        }
        // ã‚«ã‚¹ã‚¿ãƒ ã®ã¿
        if (currentFilters.customOnly && !obj.custom) return false;
        // ã‚¯ã‚¨ãƒªå¯èƒ½ã®ã¿
        if (currentFilters.queryableOnly && !obj.queryable) return false;
        return true;
      });

      renderObjectList(filtered);
    }

    /**
     * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆã‚’DOM ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
     */
    function renderObjectList(objects) {
      var container = document.getElementById('objectListContainer');
      var countEl = document.getElementById('objectCount');

      countEl.textContent = objects.length + ' ä»¶' +
        (allObjects.length !== objects.length ? 'ï¼ˆå…¨ ' + allObjects.length + ' ä»¶ä¸­ï¼‰' : '');

      if (objects.length === 0) {
        container.innerHTML = '<div style="padding:24px; text-align:center; color:#9aa0a6;">'
          + 'è©²å½“ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      var html = '';
      for (var i = 0; i < objects.length; i++) {
        var obj = objects[i];
        var badge = obj.custom
          ? '<span class="object-badge badge-custom">ã‚«ã‚¹ã‚¿ãƒ </span>'
          : '<span class="object-badge badge-standard">æ¨™æº–</span>';

        html += '<div class="object-item">'
          + '<div class="object-info">'
          + '<div class="object-label">' + escapeHtml(obj.label) + badge + '</div>'
          + '<div class="object-name">' + escapeHtml(obj.name) + '</div>'
          + '</div>'
          + '<button class="btn btn-expand" onclick="expandObject(\'' + escapeHtml(obj.name) + '\')" '
          + 'id="btn-expand-' + escapeHtml(obj.name) + '">å±•é–‹</button>'
          + '</div>';
      }

      container.innerHTML = html;
    }

    // ============================================================
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå±•é–‹
    // ============================================================

    /**
     * é¸æŠã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å±•é–‹ã™ã‚‹
     */
    function expandObject(objectApiName) {
      if (isProcessing) return;

      showProgress(objectApiName + ' ã‚’å±•é–‹ä¸­...');

      google.script.run
        .withSuccessHandler(function(result) {
          hideProgress();
          if (result.success) {
            // å„ãƒ‡ãƒ¼ã‚¿å€¤ã‚’å€‹åˆ¥ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ã‹ã‚‰HTMLçµ„ã¿ç«‹ã¦ï¼ˆXSSå¯¾ç­–ï¼‰
            var safeLabel = escapeHtml(result.data.objectLabel);
            var safeName = escapeHtml(result.data.objectName);
            var safeUrl = escapeHtml(result.data.spreadsheetUrl);
            var safeCount = escapeHtml(String(result.data.fieldCount));
            showResultHtml(
              'âœ… ' + safeLabel + ' (' + safeName + ') ã‚’å±•é–‹ã—ã¾ã—ãŸï¼<br>'
              + 'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°: ' + safeCount + ' ä»¶<br>'
              + '<a href="' + safeUrl + '" target="_blank">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã â†—</a>',
              'success'
            );
          } else {
            showResult(result.error.message, 'error');
            // èªè¨¼åˆ‡ã‚Œã®å ´åˆ
            if (result.error.code === 'AUTH_REQUIRED' || result.error.code === 'AUTH_EXPIRED') {
              showDisconnectedState();
            }
          }
        })
        .withFailureHandler(function(error) {
          hideProgress();
          showResult('å±•é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        })
        .expandObjectToSheet(objectApiName);
    }

    // ============================================================
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    // ============================================================

    /**
     * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒŠãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹
     * @param {string} elementId - è¡¨ç¤ºå…ˆã®è¦ç´ ID
     * @param {string} message - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‚HTMLã‚¿ã‚°ã¯ showMessageHtml ã‚’ä½¿ç”¨ï¼‰
     * @param {string} type - 'error' | 'success' | 'info'
     */
    function showMessage(elementId, message, type) {
      var el = document.getElementById(elementId);
      if (!el) return;
      el.className = 'message-banner visible message-' + type;
      el.innerHTML = '<button class="message-close" onclick="hideMessage(\'' + elementId + '\')">&times;</button>'
        + escapeHtml(message);
    }

    /**
     * HTMLã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒŠãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆå†…éƒ¨ã®ä¿¡é ¼ã§ãã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å°‚ç”¨ï¼‰
     * @param {string} elementId - è¡¨ç¤ºå…ˆã®è¦ç´ ID
     * @param {string} htmlMessage - HTMLãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã®ã¿ä½¿ç”¨ã™ã‚‹ã“ã¨ï¼‰
     * @param {string} type - 'error' | 'success' | 'info'
     */
    function showMessageHtml(elementId, htmlMessage, type) {
      var el = document.getElementById(elementId);
      if (!el) return;
      el.className = 'message-banner visible message-' + type;
      el.innerHTML = '<button class="message-close" onclick="hideMessage(\'' + elementId + '\')">&times;</button>'
        + htmlMessage;
    }

    /** ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒŠãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
    function hideMessage(elementId) {
      var el = document.getElementById(elementId);
      if (!el) return;
      el.className = 'message-banner';
      el.innerHTML = '';
    }

    /** çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰ */
    function showResult(message, type) {
      document.getElementById('resultSection').classList.remove('hidden');
      showMessage('resultMessage', message, type);
    }

    /** çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’HTMLä»˜ãã§è¡¨ç¤ºã™ã‚‹ï¼ˆä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã®ã¿ï¼‰ */
    function showResultHtml(htmlMessage, type) {
      document.getElementById('resultSection').classList.remove('hidden');
      showMessageHtml('resultMessage', htmlMessage, type);
    }

    // ============================================================
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
    // ============================================================

    /** ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º */
    function showProgress(message) {
      isProcessing = true;
      document.getElementById('progressMessage').textContent = message || 'å‡¦ç†ä¸­...';
      document.getElementById('progressOverlay').classList.add('visible');
    }

    /** ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹éè¡¨ç¤º */
    function hideProgress() {
      isProcessing = false;
      document.getElementById('progressOverlay').classList.remove('visible');
    }

    // ============================================================
    // ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
    // ============================================================

    /**
     * google.script.run ã® withFailureHandler å…±é€šãƒãƒ³ãƒ‰ãƒ©
     */
    function onRuntimeError(error) {
      hideProgress();
      var details = escapeHtml(error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
      if (error.stack) {
        details += '<br><small style="color:#888;font-size:11px;">' + escapeHtml(error.stack) + '</small>';
      }
      // errorã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å…¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚‚è¡¨ç¤º
      try {
        var errorKeys = Object.keys(error);
        if (errorKeys.length > 0) {
          details += '<br><small style="color:#888;font-size:11px;">Properties: ' + escapeHtml(JSON.stringify(error)) + '</small>';
        }
      } catch(e) {}
      showMessageHtml('authMessage',
        escapeHtml('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚') + '<br>' + details,
        'error');
      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
      console.error('onRuntimeError:', error);
      console.error('Error message:', error.message);
      console.error('Error name:', error.name);
      console.error('Error stack:', error.stack);
      console.error('Error JSON:', JSON.stringify(error));
    }

    // ============================================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================================

    /** HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— */
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

  </script>
</body>
</html>
